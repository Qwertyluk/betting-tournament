@using BettingTournament.Components.Common
@using BettingTournament.Core
@using BettingTournament.Core.Models
@using BettingTournament.Core.Services
@inject RoundService RoundService
@inject IDialogService DialogService
@inject ScoreService ScoreService

<MudContainer>
    <MudDataGrid Items="@_games">
        <Columns>
            <PropertyColumn Property="x => x.HomeTeam" />
            <PropertyColumn Property="x => x.AwayTeam" />
            <PropertyColumn Property="x => x.HomeScore" />
            <PropertyColumn Property="x => x.AwayScore" />
            <PropertyColumn Property="x => x.PolishDateTime" Format="dd.MM.yyyy HH:mm:ss" />
            <TemplateColumn>
                <CellTemplate>
                    <Button OnClick="() => SetResultClicked(context.Item)">Set Result</Button>
                    <Button OnClick="() => UpdateClicked(context.Item)">Update</Button>
                    <Button OnClick="() => RemoveClicked(context.Item)">Remove</Button>
                    <Button OnClick="() => FinishClicked(context.Item)">Finish</Button>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
    <Button OnClick="AddGameClicked">Add Game</Button>
</MudContainer>

@code {
    private IEnumerable<Game> _games = [];

    protected override void OnInitialized()
    {
        base.OnInitialized();

        Refresh();
    }

    private async Task SetResultClicked(Game game)
    {
        var parameters = new DialogParameters<SetResultDialog>()
        {
            { x => x.Game , game},
        };

        var dialog = DialogService.Show<SetResultDialog>("", parameters);
        await dialog.Result;
        Refresh();
    }

    private async Task UpdateClicked(Game game)
    {
        var parameters = new DialogParameters<UpdateGameDialog>()
        {
            { x => x.Game , game},
        };

        var dialog = DialogService.Show<UpdateGameDialog>("", parameters);
        await dialog.Result;
        Refresh();
    }

    private void RemoveClicked(Game game)
    {
        RoundService.Remove(game.Id);
        Refresh();
    }

    private void FinishClicked(Game game)
    {
        ScoreService.FinishGame(game.Id);
        Refresh();
    }

    private async Task AddGameClicked()
    {
        var dialog = DialogService.Show<NewGameDialog>();
        await dialog.Result;
        Refresh();
    }

    private void Refresh()
    {
        _games = RoundService.GetGames();
    }
}